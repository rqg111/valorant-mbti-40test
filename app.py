import streamlit as st
import pandas as pd
import plotly.graph_objects as go

# ==========================================
# 1. アプリ設定 & データ読み込み
# ==========================================
st.set_page_config(page_title="VALO-TYPE 40", page_icon="🎯")
st.title("🎯 VALO-TYPE 40")
st.write("プロ仕様の40問で、あなたのプレイスタイルを精密に分析します。")

@st.cache_data
def load_data():
    # 作成したExcelファイルを読み込む
    return pd.read_excel("valorant_questions_v2.xlsx")

try:
    df = load_data()
except Exception as e:
    st.error("エラー: 'valorant_questions_v2.xlsx' が読み込めません。GitHubにアップロードされているか確認してください。")
    st.stop()

# ==========================================
# 2. 診断フォーム (5段階評価)
# ==========================================
user_scores = []
# 選択肢の定義（1〜5点）
options = {1: "全く違う", 2: "あまりない", 3: "どちらでもない", 4: "まあまあある", 5: "強くそう思う"}

with st.form("diagnosis_form"):
    st.write("以下の質問に、直感で答えてください。")
    for index, row in df.iterrows():
        st.subheader(f"Q{index+1}. {row['question']}")
        # 5段階のスライダーを表示
        choice = st.select_slider(
            "あてはまる度合い:",
            options=[1, 2, 3, 4, 5],
            format_func=lambda x: options[x], # 数値を文字に変換して表示
            key=f"q_{index}",
            value=3 # デフォルトは真ん中
        )
        user_scores.append({"category": row['category'], "score": choice})
    
    st.write("---")
    submit_btn = st.form_submit_button("全40問の結果を解析する")

# ==========================================
# 3. 解析ロジック & 結果表示
# ==========================================
if submit_btn:
    # --- 集計 ---
    summary = {"Aggro": 0, "Logic": 0, "Stoic": 0, "Teamwork": 0}
    counts = {"Aggro": 0, "Logic": 0, "Stoic": 0, "Teamwork": 0}
    
    for item in user_scores:
        cat = item["category"]
        if cat in summary:
            summary[cat] += item["score"]
            counts[cat] += 1
            
    # 平均点（1.0〜5.0）を算出
    avg = {k: v / counts[k] if counts[k] > 0 else 0 for k, v in summary.items()}

    # --- タイプ判定 (しきい値 3.2) ---
    threshold = 3.2
    m = ""
    m += "A" if avg["Aggro"] >= threshold else "P"
    m += "L" if avg["Logic"] >= threshold else "I"
    m += "S" if avg["Stoic"] >= threshold else "E"
    m += "T" if avg["Teamwork"] >= threshold else "C"

    # --- 適性ロール判定 (一番高い数値を参照) ---
    max_stat = max(avg, key=avg.get)
    if max_stat == "Aggro": best_role = "Duelist"
    elif max_stat == "Teamwork": best_role = "Initiator"
    elif max_stat == "Logic": best_role = "Sentinel"
    else: best_role = "Controller"

    # ==========================================
    # 16タイプ × 4ロール 全64パターン解説
    # ==========================================
    combo_advice = {
        "ALST": {
            "Duelist": "IGL（指揮官）を兼任するジェット。感情に任せて突っ込むのではなく、味方のスキル状況を完璧に把握し、勝率の高いタイミングでのみエントリーする。",
            "Initiator": "ソーヴァを使わせたら定点の鬼。味方が撃ち合いやすい環境を完璧に整え、自分は後方から冷静に状況報告とクラッチを狙う。",
            "Sentinel": "お手本のようなキルジョイやサイファー。敵の進行ルートを完全に予測し、サイト内を要塞化して完封する守りの要。",
            "Controller": "味方の位置を見ながら0.1秒単位でスモークを管理するアストラやヴァイパー。報告量が多く、チーム全体の動きをコントロールする。"
        },
        "ALSC": {
            "Duelist": "ヨルやアイソで裏取りや撹乱を繰り返す知能犯。味方とは別行動を取りつつ、敵の意表を突くタイミングでキルを重ねる。",
            "Initiator": "フェイドやKAY/Oで自分のために情報を取る。味方のカバーを期待するより、自分で敵の位置を暴いて自分で倒しに行くスタイル。",
            "Sentinel": "チェンバーで強気のワンピックを狙う。守る気があまりなく、オペレーターを持って攻撃的なポジションで敵を狩り続ける。",
            "Controller": "オーメンやクローヴで、スモークの中や上から奇襲をかける。「そこにはいないだろ」という場所を取り、敵の精神を破壊する。"
        },
        "ALET": {
            "Duelist": "レイズやネオンで「いけいけ！」と声を出しながら突っ込む。勢いだけでなく、セットアップや合わせもしっかり要求する頼れるリーダー。",
            "Initiator": "ゲッコーやブリーチで「フラッシュ入れるよ！」と大声で報告。味方を動かすのがうまく、ラッシュの起点を作るのが大好き。",
            "Sentinel": "デッドロックやセージで、壁を使って強引に設置や解除を通す。守りでもじっとしているより、味方と一緒に前目で当たりたがる。",
            "Controller": "ブリムストーンでスティムビーコンを投げ、「全員で突っ込め！」と号令をかける。スモーク抜きや解除阻止の定点も熱心に研究している。"
        },
        "ALEC": {
            "Duelist": "レイナやフェニックスで、K/D（キルレ）重視の立ち回り。自分がいかに有利に撃ち合えるかだけを計算し、不利なら味方を見捨てて引く判断も速い。",
            "Initiator": "スカイやKAY/Oを「自分のフラッシュ」として使う。索敵スキルをデコイにして、自分が飛び出してキルを取るフィジカルゴリラ。",
            "Sentinel": "サイファーのカメラやワイヤーを「自分がキルを取るための罠」として使う。サイトを守るというより、罠にかかった獲物を狩る感覚。",
            "Controller": "ヴァイパーやハーバーで視界を切り、ショットガンや近距離戦に持ち込む。エリアコントロールよりも、閉鎖空間でのデスマッチを好む。"
        },
        "AIST": {
            "Duelist": "ジェットやレイナで、直感的に「今ならいける」と感じた瞬間に飛び出す。理屈はないが、なぜかタイミングが完璧で敵を壊滅させる。",
            "Initiator": "ブリーチやスカイで、敵がいそうな場所に感覚でスキルを放つ。細かいセットアップは苦手だが、アドリブ力で乱戦を制する。",
            "Sentinel": "チェンバーやセージで、予測不可能なオフアングル（変な場所）に立つ。敵の思考の外側からエイムでねじ伏せる。",
            "Controller": "オーメンで予測不能なテレポートを見せる。「なんでそこにいるの！？」と敵が驚くような動きで前線を荒らす。"
        },
        "AISC": {
            "Duelist": "ヨルやネオンで単独行動を愛する。味方のカバーは期待せず、マップ中を走り回って孤立した敵を食い荒らす。",
            "Initiator": "ソーヴァのドローンよりも、自分の体でピークして情報を取る。スキルはあくまで「自分が有利に撃ち合うための道具」という認識。",
            "Sentinel": "キルジョイのタレットを囮にして自分が横から撃つ。守りでもガンガンプッシュして、敵リス付近まで荒らしに行く。",
            "Controller": "クローヴを使って、死んでもいいやの精神で突っ込む。スモーク役としての責任感は薄いが、キル能力は高い。"
        },
        "AIET": {
            "Duelist": "フェニックスやレイズで、VCで叫びながら先頭を走る。デスしても「ドンマイ次！」と雰囲気を明るくする、チームのムードメーカー。",
            "Initiator": "KAY/Oやゲッコーで、味方のために全力でスキルを吐く。タイミングが合わなくても気にしない。「とりあえず行こうぜ！」精神。",
            "Sentinel": "セージでバトルセージ化する。味方の回復よりも、壁に乗って敵の意表を突くことに命を懸けている。",
            "Controller": "ハーバーやブリムストーンで、とにかく現場へ急行する。細かいスモークの位置よりも、味方と一緒に戦うことを優先する。"
        },
        "AIEC": {
            "Duelist": "レイナ即ピック。フラッシュも要求せず、自分のエイムだけで全てを解決しようとする。調子が良い時は最強、悪い時はトロール。",
            "Initiator": "スカイの鳥を適当に飛ばして、光った瞬間に自分も飛び出す。味方の目は潰れるかもしれないが、敵を倒せば問題ない。",
            "Sentinel": "チェンバーでオペレーターを持ち、外したらハンドガンで突っ込む。守るという概念はなく、常に攻めている。",
            "Controller": "オーメンでULTを持って敵陣のど真ん中に飛ぶ。成功率は低いが、成功した時の脳汁のためにプレイしている。"
        },
        "PLST": {
            "Duelist": "慎重なジェット。エントリー前にスモークやドローンをしっかり待ち、クリアリングをサボらない。生存率が非常に高い。",
            "Initiator": "フェイドやソーヴァで、クリアリング漏れがないように徹底的に索敵する。味方が死なないよう、細心の注意を払ってスキルを使う。",
            "Sentinel": "教科書通りのキルジョイやサイファー。セットアップ動画を研究し、絶対に突破されない完璧な配置を追求する。",
            "Controller": "アストラやヴァイパーで、数秒先の未来を予測してスモークを置く。味方からの信頼が厚く、「そこに欲しかった」という場所に必ずある。"
        },
        "PLSC": {
            "Duelist": "レイナやアイソで、味方を盾にしながら確実にトレードキル（交換）を取る。自分がファーストブラッドになるリスクは冒さない。",
            "Initiator": "ソーヴァで最後尾に位置し、自分は安全圏からショックダーツでキルを狙う。残った人数でのクラッチプレイが得意。",
            "Sentinel": "サイファーで、自分だけが一方的に撃てるカメラやワンウェイケージを多用する。敵に姿を見せずに殺すことに快感を覚える。",
            "Controller": "ヴァイパーで定点空爆（解除阻止）を狙う。設置後はサイトから離れ、ラインアップで時間を稼いで勝つ知能犯。"
        },
        "PLET": {
            "Duelist": "フェニックスやヨルで、味方に「フラッシュ入れて！」と細かく指示を出しながら動く。連携が上手くいかないとVCで熱くなりがち。",
            "Initiator": "ブリーチやKAY/Oで、味方の動きに合わせて完璧なサポートをしようと努力する。味方が突っ込んでくれないと悲しくなる。",
            "Sentinel": "セージやデッドロックで、味方の蘇生やカバーに命を懸ける。「死なせない！」という思いが強く、献身的なプレイが光る。",
            "Controller": "オーメンやブリムストーンで、味方の進行ルートに合わせてスモークを炊き続ける。VC報告の声が一番大きいタイプ。"
        },
        "PLEC": {
            "Duelist": "ヨルやネオンで、誰も見ていないルートを静かに進行する。派手なマルチキルより、重要な1キルを確実に取る仕事を好む。",
            "Initiator": "フェイドやスカイで、必要な情報を淡々と報告する。味方との馴れ合いはせず、自分の役割（索敵）を完璧にこなすことに集中する。",
            "Sentinel": "ワットソンやキルジョイで、毎回同じ配置に見えて少しずつ位置を変える。敵の学習能力を逆手に取る、いぶし銀のプレイスタイル。",
            "Controller": "アストラで、必要な場所に淡々と星を置く。派手さはないが、リザルト画面を見るとアシスト数が一番多い。"
        },
        "PIST": {
            "Duelist": "ジェットやレイナで、足音を消して近づき、気づかれないように一人ずつ処理する。エントリーよりもラーク（裏取り）の才能がある。",
            "Initiator": "ソーヴァのリコンを直感で刺さる場所に撃つ。VCでの報告は少ないが、ピン刺しだけで味方を誘導する。",
            "Sentinel": "サイファーで、敵が引っかかるのをじっと待つ。忍耐力が凄まじく、3分間同じ場所を見続けることも苦にならない。",
            "Controller": "オーメンやクローヴで、スモークの中に潜むのが得意。敵が通り過ぎた背後から静かにナイフを突き立てる。"
        },
        "PISC": {
            "Duelist": "アイソやレイナで、味方のラッシュには参加せず、逆サイトで時間を稼ぐ。自分のペースを崩さず、1対1の状況を作り出す。",
            "Initiator": "ゲッコーのウィングマンに設置や解除を任せ、自分は安全な場所で武器を構える。リスク管理能力が高い（ビビリとも言う）。",
            "Sentinel": "チェンバーで自分の身を守ることに特化する。サイトが守れないと判断したら、誰よりも早くリテイク（取り返し）位置まで下がる。",
            "Controller": "ヴァイパーのカーテンを上げて、自分だけの安全地帯を作る。チームの勝敗よりも、自分のK/Dを維持することを重視する。"
        },
        "PIET": {
            "Duelist": "フェニックスやネオンで、味方が怖がっている時に「僕が先に行くよ」と勇気を出して飛び込む。エイムは震えていることが多い。",
            "Initiator": "スカイやゲッコーで、味方の回復や回収を優先する。敵を倒すことよりも、味方が生き残ることに喜びを感じる。",
            "Sentinel": "セージを使って、傷ついた味方を見つけると即座に回復へ走る。壁も自分用ではなく、蘇生を通すために使う。",
            "Controller": "ブリムストーンで、味方が通りそうな場所全てにスモークを炊いてあげる。優しすぎてスモークが足りなくなることもしばしば。"
        },
        "PIEC": {
            "Duelist": "レイズでブラストパックを使って飛び回るのが楽しい。エントリーの成功率より、楽しさと芸術点を重視するエンジョイ勢。",
            "Initiator": "ブリーチやKAY/Oで、適当にスキルを撃って「なんか当たった！」と喜ぶ。細かいことは気にせず、その場のノリで戦う。",
            "Sentinel": "デッドロックやセージで、変な場所に壁を作って敵を困惑させる。クリエイティブな発想で、敵も味方も驚かせる。",
            "Controller": "ハーバーやオーメンで、直感的にスモークを出す。「ここ危なそう！」という勘が当たれば強いが、外れると味方の邪魔になる。"
        }
    }

    # --- 16タイプの結果タイトル定義 ---
    results_data = {
        "ALST": "冷静な戦術指揮官", "ALSC": "孤高の天才軍師", "ALET": "理論武装した情熱家", "ALEC": "計算された破壊屋",
        "AIST": "本能で動くエース", "AISC": "野生の狩人", "AIET": "熱き突撃隊長", "AIEC": "暴走する破壊神",
        "PLST": "完璧主義の守護神", "PLSC": "冷徹な影の支配者", "PLET": "盤面の教育者", "PLEC": "職人気質の仕事人",
        "PIST": "静かなる暗殺者", "PISC": "マイペースな仕事師", "PIET": "心優しいサポーター", "PIEC": "感性豊かなムードメーカー"
    }
    title = results_data.get(m, "変幻自在なエージェント")

    # ★修正ポイント: ここで辞書から文章を取り出しています！
    final_advice = combo_advice.get(m, {}).get(best_role, "データなし")

    # --- 画面表示 ---
    st.balloons()
    st.header(f"あなたのタイプ: {m}型")
    st.subheader(f"「{title}」")
    st.info(f"適性ロール: **{best_role}**")
    
    # ★修正ポイント: ここで画面に表示させています！
    st.success(f"🦸 **{m} × {best_role} のプレイスタイル**\n\n{final_advice}")

    # --- レーダーチャート描画 ---
    categories = ['積極性(A)', '論理性(L)', '精神安定(S)', '協力意識(T)']
    values = [avg["Aggro"], avg["Logic"], avg["Stoic"], avg["Teamwork"]]
    values += values[:1] 
    categories += categories[:1]

    fig = go.Figure()
    fig.add_trace(go.Scatterpolar(
        r=values,
        theta=categories,
        fill='toself',
        line_color='#ff4b4b'
    ))
    fig.update_layout(
        polar=dict(radialaxis=dict(visible=True, range=[1, 5])),
        showlegend=False,
        title="プレイスタイル分析グラフ"
    )
    st.plotly_chart(fig)

    # --- Discord共有用テキスト ---
    st.write("### 💬 Discord共有用テキスト")
    share_text = f"**【VALO-TYPE 40 診断結果】**\n🛡️ タイプ: {title} ({m}型)\n🔫 適性ロール: {best_role}\n📊 A:{avg['Aggro']:.1f} / L:{avg['Logic']:.1f} / S:{avg['Stoic']:.1f} / T:{avg['Teamwork']:.1f}\n#VALOTYPE40"
    st.code(share_text, language=None)
    st.caption("テキストをコピーして貼り付けてね！グラフはスクショでシェア！")